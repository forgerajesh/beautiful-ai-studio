<!doctype html>
<html>
<head>
  <meta charset='utf-8'>
  <meta name='viewport' content='width=device-width, initial-scale=1'>
  <title>Dashboard</title>
  <style>
    :root{--bg:#f4f7ff;--card:#fff;--text:#0f172a;--muted:#64748b;--line:#dbe3f3;--brand:#2563eb;--brand2:#1d4ed8}
    *{box-sizing:border-box}
    body{font-family:Inter,Segoe UI,Arial,sans-serif;margin:0;background:linear-gradient(180deg,#eff4ff,#f9fbff);color:var(--text)}
    .wrap{max-width:1200px;margin:24px auto;padding:0 16px}
    .top{background:var(--card);border:1px solid var(--line);border-radius:16px;padding:18px 20px;margin-bottom:14px}
    .top h1{margin:0 0 8px}
    .muted{color:var(--muted)}
    .row{display:grid;grid-template-columns:repeat(4,1fr);gap:12px}
    .kpi{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:14px}
    .kpi .v{font-size:24px;font-weight:700}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:14px;margin-top:14px}
    .card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:14px}
    input,select,textarea{width:100%;padding:10px;border:1px solid #cfdaf0;border-radius:10px;margin-top:8px}
    button{margin-top:10px;background:linear-gradient(180deg,var(--brand),var(--brand2));color:#fff;border:0;border-radius:10px;padding:10px 14px;font-weight:600;cursor:pointer}
    table{width:100%;border-collapse:collapse}
    th,td{padding:9px;border-bottom:1px solid #e5ecfa;font-size:13px;text-align:left;vertical-align:top}
    .actions{float:right}
    @media (max-width:1000px){.row{grid-template-columns:1fr 1fr}.grid{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <div class='wrap'>
    <div class='top'>
      <div class='actions'><a href='/'>Home</a> · <a href='/logout'>Logout</a></div>
      <h1>{{user.name}} — Performance Dashboard</h1>
      <div class='muted'>Current: <b>{{user.weight_kg}}kg</b> · Goal: <b>{{user.goal_weight_kg}}kg</b> · Timeline: <b>{{user.target_weeks}} weeks</b> · Workout days: <b>{{user.workout_days}}</b>/week</div>
    </div>

    <div class='row'>
      <div class='kpi'><div class='muted'>Entries (7d)</div><div class='v'>{{analytics.entries if analytics else 0}}</div></div>
      <div class='kpi'><div class='muted'>Avg steps (7d)</div><div class='v'>{{analytics.avg_steps if analytics and analytics.avg_steps else "—"}}</div></div>
      <div class='kpi'><div class='muted'>Diet adherence (7d)</div><div class='v'>{{analytics.avg_adherence ~ "%" if analytics and analytics.avg_adherence else "—"}}</div></div>
      <div class='kpi'><div class='muted'>Weight change (7d)</div><div class='v'>{{analytics.weight_change_kg ~ "kg" if analytics and analytics.weight_change_kg is not none else "—"}}</div></div>
      <div class='kpi'><div class='muted'>Habit streak</div><div class='v'>{{advanced.streak_days if advanced else 0}}d</div></div>
      <div class='kpi'><div class='muted'>Plateau status</div><div class='v'>{{"Yes" if advanced and advanced.plateau else "No"}}</div></div>
    </div>

    <div class='grid'>
      <div class='card'>
        <h3>Personalized Plan</h3>
        <form method='post' action='/generate-plan/{{user.id}}'>
          <button type='submit'>Generate / Refresh Plan</button>
        </form>
        {% if plan %}
          <p><b>Calories:</b> {{plan.calories}} kcal · <b>Protein:</b> {{plan.protein_g}}g · <b>Carbs:</b> {{plan.carbs_g}}g · <b>Fats:</b> {{plan.fats_g}}g</p>
          <p><b>Meals:</b> {{plan.meals}}</p>
          <p><b>Workouts:</b> {{plan.workouts}}</p>
          <p><b>Coach Notes:</b> {{plan.notes}}</p>
        {% else %}
          <p class='muted'>No plan yet. Generate your first plan now.</p>
        {% endif %}
      </div>

      <div class='card'>
        <h3>Daily Check-in</h3>
        <form method='post' action='/checkin/{{user.id}}'>
          <input type='number' step='0.1' name='weight_kg' placeholder='Weight (kg)' required>
          <input type='number' name='steps' placeholder='Steps' value='8000' required>
          <label style='display:block;margin-top:8px'><input type='checkbox' name='workout_done' value='1'> Workout done today</label>
          <input type='number' name='diet_adherence' placeholder='Diet adherence %' value='75' min='0' max='100' required>
          <select name='mood'><option>great</option><option selected>ok</option><option>low</option></select>
          <textarea name='notes' placeholder='How did your day go?'></textarea>
          <input name='photo_url' placeholder='Progress photo URL (optional)'>
          <button type='submit'>Save Check-in</button>
        </form>
      </div>
    </div>

    <div class='card' style='margin-top:14px'>
      <h3>Adaptive Coach Guidance</h3>
      <p><b>Recommendation:</b> {{advanced.recommendation if advanced else "Keep logging data for better guidance."}}</p>
      <p><b>Daily Nudge Preview (Telegram / WhatsApp):</b><br>{{nudge_preview}}</p>
      <p class='muted'>Programmatic nudge API: <code>/api/nudge/{{user.id}}</code></p>
    </div>

    <div class='card' style='margin-top:14px'>
      <h3>Weekly Meal Planner + Shopping List</h3>
      <p class='muted'>Food library API: <code>/api/food/library/{{user.id}}</code> · Meal swap API: <code>POST /api/meal/swap/{{user.id}}</code></p>
      <table>
        <thead><tr><th>Day</th><th>Breakfast</th><th>Lunch</th><th>Dinner</th><th>Snack</th></tr></thead>
        <tbody>
          {% for d in planner_preview.days %}
          <tr>
            <td>{{d.day}}</td><td>{{d.breakfast}}</td><td>{{d.lunch}}</td><td>{{d.dinner}}</td><td>{{d.snack}}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
      <p><b>Shopping List:</b> {{ planner_preview.shopping_list | join(', ') }}</p>
    </div>

    <div class='card' style='margin-top:14px'>
      <h3>Charts + Reminder Scheduler</h3>
      <p>Weight chart API: <code>/api/chart/weight/{{user.id}}</code></p>
      <p>Reminder APIs: <code>POST /api/reminder/{{user.id}}</code> · <code>GET /api/reminder/{{user.id}}</code></p>
      <p class='muted'>Use reminder payload example: <code>{"remind_at":"2026-02-12T06:30:00Z","channel":"telegram","message":"Check in now"}</code></p>
    </div>

    <div class='card' style='margin-top:14px'>
      <h3>Progress Log (latest first)</h3>
      <table>
        <thead><tr><th>Date</th><th>Weight</th><th>Steps</th><th>Adherence</th><th>Photo</th><th>Comment</th></tr></thead>
        <tbody>
          {% for c in checkins %}
          <tr>
            <td>{{c.date}}</td>
            <td>{{c.weight_kg}} kg</td>
            <td>{{c.steps}}</td>
            <td>{{c.diet_adherence}}%</td>
            <td>{% if c.photo_url %}<a href='{{c.photo_url}}' target='_blank'>View</a>{% else %}-{% endif %}</td>
            <td>{{c.coach_comment}}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</body>
</html>
