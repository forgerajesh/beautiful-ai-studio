suite: demo_etl_validation
ai:
  enabled: false
  model: gpt-4o-mini
  base_url: https://api.openai.com/v1
adapter:
  kind: sqlite
  database_path: demo_etl.db

tests:
  - id: schema_target_orders
    type: schema
    severity: critical
    tags: [critical, schema]
    params:
      table: "{{entity.target_orders}}"
      expected_columns:
        - {name: order_id, type: INTEGER, nullable: false}
        - {name: customer_id, type: INTEGER, nullable: false}
        - {name: amount, type: REAL, nullable: false}
        - {name: updated_at, type: TEXT, nullable: false}

  - id: rowcount_source_vs_target
    type: rowcount_recon
    severity: high
    tags: [recon]
    params:
      source_sql: "select count(*) from {{entity.source_orders}}"
      target_sql: "select count(*) from {{entity.target_orders}}"
      tolerance_pct: 0.0

  - id: business_rule_amount_positive
    type: business_rule
    severity: critical
    tags: [rule]
    params:
      sql: "select count(*) from {{entity.target_orders}} where {{rule.amount_positive}}"
      expected: 0

  - id: incremental_watermark_lag
    type: incremental
    severity: critical
    tags: [incremental]
    params:
      sql: "select (strftime('%s','now') - strftime('%s', max(updated_at))) / 60.0 from {{entity.target_orders}}"
      max_lag_minutes: 120

  - id: scd2_single_current
    type: scd2
    severity: critical
    tags: [scd2]
    params:
      sql: |
        select count(*)
        from {{entity.customer_hist}}
        where {{rule.one_current_record_per_customer}}
      expected_rows: 0
