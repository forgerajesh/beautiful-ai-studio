version: '3.9'

services:
  redis:
    image: redis:7-alpine
    restart: unless-stopped
    command: ["redis-server", "--appendonly", "yes"]
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 3s
      retries: 5
    profiles: ["queue", "prod"]

  api:
    build: .
    command: uvicorn app.api.server:app --host 0.0.0.0 --port 8090
    restart: unless-stopped
    environment:
      - REDIS_URL=redis://redis:6379/0
      - REDIS_RESULT_BACKEND=redis://redis:6379/1
      - JWT_AUTH_MODE=${JWT_AUTH_MODE:-auto}
      - JWT_AUTH_ALLOW_FALLBACK=${JWT_AUTH_ALLOW_FALLBACK:-true}
      - OIDC_ISSUER_URL=${OIDC_ISSUER_URL:-}
      - OIDC_JWKS_URL=${OIDC_JWKS_URL:-}
      - OIDC_AUDIENCE=${OIDC_AUDIENCE:-}
      - OPA_POLICY_URL=${OPA_POLICY_URL:-}
    depends_on:
      redis:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8090/health', timeout=3)"]
      interval: 15s
      timeout: 5s
      retries: 6
    ports:
      - "8090:8090"
    profiles: ["api", "prod"]

  worker:
    build: .
    command: celery -A app.wave1.queue.celery_app.celery_app worker --loglevel=info --concurrency=2 --without-gossip --without-mingle
    restart: unless-stopped
    environment:
      - REDIS_URL=redis://redis:6379/0
      - REDIS_RESULT_BACKEND=redis://redis:6379/1
    depends_on:
      redis:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "python", "-c", "from app.wave1.queue.celery_app import celery_app; i=celery_app.control.inspect(timeout=2); p=i.ping() if i else None; raise SystemExit(0 if p else 1)"]
      interval: 20s
      timeout: 8s
      retries: 3
    profiles: ["worker", "prod"]

  flower:
    build: .
    command: celery -A app.wave1.queue.celery_app.celery_app flower --port=5555
    restart: unless-stopped
    environment:
      - REDIS_URL=redis://redis:6379/0
      - REDIS_RESULT_BACKEND=redis://redis:6379/1
    depends_on:
      redis:
        condition: service_healthy
    ports:
      - "5555:5555"
    profiles: ["ops"]
